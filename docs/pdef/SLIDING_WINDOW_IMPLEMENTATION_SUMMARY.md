# PDEF æ»‘åŠ¨çª—å£ä¸æµæ°´çº¿æ¶æ„å®ç°æ€»ç»“

##  å·²å®ŒæˆåŠŸèƒ½

### 1. PDEF æ»‘åŠ¨çª—å£åŒ¹é…ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

**å®ç°æ–‡ä»¶**ï¼š
- `src/pdef/pdef_types.h` - æ·»åŠ  `sliding_window` å’Œ `sliding_max_offset` å­—æ®µ
- `src/pdef/parser.c` - è§£æå™¨æ”¯æŒ `sliding` å’Œ `sliding_max` è¯­æ³•
- `src/runtime/protocol.c` - è¿è¡Œæ—¶æ»‘åŠ¨çª—å£åŒ¹é…é€»è¾‘

**è¯­æ³•ç¤ºä¾‹**ï¼š
```c
@filter GI_Anywhere {
    sliding = true;          // å¯ç”¨æ»‘åŠ¨çª—å£
    sliding_max = 512;       // é™åˆ¶æœç´¢èŒƒå›´ï¼ˆå¯é€‰ï¼Œ0=æ— é™åˆ¶ï¼‰
    apci.start = 0x68;
    asdu.type_id = 100;
}
```

**å·¥ä½œåŸç†**ï¼š
- `sliding = false` (é»˜è®¤)ï¼šä»åŒ…å¤´å¼€å§‹åŒ¹é…ï¼ˆä¼ ç»Ÿæ¨¡å¼ï¼‰
- `sliding = true`ï¼šåœ¨æ•´ä¸ªåŒ…ä¸­æœç´¢åŒ¹é…æ¨¡å¼ï¼ˆæ»‘åŠ¨çª—å£æ¨¡å¼ï¼‰
- `sliding_max = N`ï¼šé™åˆ¶æœç´¢èŒƒå›´ä¸ºå‰Nå­—èŠ‚ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- æå‰ç»“æŸï¼šå¦‚æœå‰©ä½™é•¿åº¦ < min_packet_sizeï¼Œåœæ­¢æœç´¢
- é™åˆ¶æœç´¢èŒƒå›´ï¼š`sliding_max` é¿å…åœ¨è¶…é•¿åŒ…ä¸­æœç´¢
- å¿«é€Ÿè·¯å¾„ï¼šä¼ ç»Ÿæ¨¡å¼é›¶å¼€é”€

### 2. çº¿ç¨‹é—´æ¶ˆæ¯é€šä¿¡åŸºç¡€è®¾æ–½

**å®ç°æ–‡ä»¶**ï¼š
- `src/rxmsgtypes.h` - å®šä¹‰ `RX_MSG_PACKET_CAPTURED` å’Œ `RX_MSG_PACKET_FILTERED`
- `src/rxfilterthread.h/cpp` - è¿‡æ»¤çº¿ç¨‹ç±»ï¼ˆç»§æ‰¿ `base_net_thread`ï¼‰
- `src/rxwriterthread.h/cpp` - å†™å…¥çº¿ç¨‹ç±»ï¼ˆç»§æ‰¿ `base_net_thread`ï¼‰
- `src/rxlockfreequeue.h/c` - æ— é”é˜Ÿåˆ—ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

**è®¾è®¡ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨æ¡†æ¶å†…ç½®çš„æ¶ˆæ¯æœºåˆ¶ï¼ˆ`normal_msg`ï¼‰
- éµå¾ªç°æœ‰çº¿ç¨‹æ¨¡å¼ï¼ˆä¸ `CRxSampleThread`, `CRxReloadThread` ä¸€è‡´ï¼‰
- æ”¯æŒä¸¤ç§æ¨¡å¼ï¼šæ¶ˆæ¯æ¨¡å¼ï¼ˆå·²å®ç°ï¼‰å’Œé˜Ÿåˆ—æ¨¡å¼ï¼ˆå·²å‡†å¤‡ï¼‰

**æ¶ˆæ¯æµ**ï¼š
```
[æŠ“åŒ…çº¿ç¨‹] --RX_MSG_PACKET_CAPTURED--> [è¿‡æ»¤çº¿ç¨‹] --RX_MSG_PACKET_FILTERED--> [å†™å…¥çº¿ç¨‹]
```

## ğŸ“‹ å½“å‰çŠ¶æ€

### å¯ç«‹å³ä½¿ç”¨çš„åŠŸèƒ½

 **PDEF æ»‘åŠ¨çª—å£**å·²ç»å®Œå…¨å¯ç”¨ï¼š

```bash
# 1. ç¼–å†™å¸¦æ»‘åŠ¨çª—å£çš„ PDEF
cat > my_protocol.pdef <<EOF
@protocol {
    name = "MyProto";
    ports = 1234;
    endian = little;
}

Header {
    uint8  magic;
    uint32 length;
}

@filter FindMagic {
    sliding = true;
    sliding_max = 1024;
    header.magic = 0xAB;
}
EOF

# 2. ä½¿ç”¨ï¼ˆå½“å‰æŠ“åŒ…æ¨¡å¼ä»ç„¶æ˜¯è¾¹æŠ“è¾¹è¿‡æ»¤ï¼‰
curl -X POST http://localhost:8080/api/capture/start \
  -H "Content-Type: application/json" \
  -d '{
    "iface": "eth0",
    "filter": "tcp port 1234",
    "protocol_filter": "/path/to/my_protocol.pdef"
  }'
```

### éœ€è¦è¿›ä¸€æ­¥é›†æˆçš„åŠŸèƒ½

 **æµæ°´çº¿æ¶æ„**ï¼ˆè¿‡æ»¤/å†™å…¥çº¿ç¨‹ï¼‰ï¼š
- çº¿ç¨‹ç±»å·²å®ç°
- éœ€è¦é›†æˆåˆ° `CRxCaptureJob` æˆ– `CRxCaptureManagerThread`
- éœ€è¦å†³å®šï¼šå…¨å±€çº¿ç¨‹æ±  vs æ¯ä¼šè¯çº¿ç¨‹

## ğŸ¯ ä½¿ç”¨å»ºè®®

### åœºæ™¯ 1ï¼šåªéœ€æ»‘åŠ¨çª—å£åŠŸèƒ½

**å½“å‰çŠ¶æ€**ï¼š å®Œå…¨å¯ç”¨

```c
// åœ¨ PDEF ä¸­ä½¿ç”¨æ»‘åŠ¨çª—å£
@filter MyFilter {
    sliding = true;        // å¯ç”¨
    sliding_max = 512;     // é™åˆ¶æœç´¢ï¼ˆæ¨èï¼‰
    // ... å…¶ä»–åŒ¹é…æ¡ä»¶
}
```

**æ€§èƒ½è€ƒè™‘**ï¼š
- ä½æµé‡ï¼ˆ< 100 Mbpsï¼‰ï¼šå¯ä»¥ä¸é™åˆ¶ `sliding_max`
- ä¸­æµé‡ï¼ˆ100-500 Mbpsï¼‰ï¼šå»ºè®® `sliding_max = 512` æˆ– `1024`
- é«˜æµé‡ï¼ˆ> 500 Mbpsï¼‰ï¼šå»ºè®® `sliding_max = 256`ï¼Œæˆ–ä½¿ç”¨é¦–å­—èŠ‚ä¼˜åŒ–

### åœºæ™¯ 2ï¼šéœ€è¦é«˜æ€§èƒ½æµæ°´çº¿

**å½“å‰çŠ¶æ€**ï¼šâ¸ï¸ éœ€è¦è¿›ä¸€æ­¥é›†æˆ

**é›†æˆé€‰é¡¹ A**ï¼šç®€åŒ–ç‰ˆï¼ˆæ¨èç”¨äºå¿«é€ŸéªŒè¯ï¼‰
- åœ¨å½“å‰æŠ“åŒ…å›è°ƒä¸­ç›´æ¥ä½¿ç”¨æ»‘åŠ¨çª—å£
- æ— éœ€é¢å¤–çº¿ç¨‹
- é€‚åˆï¼šä¸­ä½æµé‡ï¼Œç®€å•éªŒè¯

**é›†æˆé€‰é¡¹ B**ï¼šå®Œæ•´æµæ°´çº¿
- å¯ç”¨è¿‡æ»¤/å†™å…¥çº¿ç¨‹
- æŠ“åŒ…ã€è¿‡æ»¤ã€å†™å…¥åˆ†ç¦»
- é€‚åˆï¼šé«˜æµé‡ç”Ÿäº§ç¯å¢ƒï¼ˆéœ€è¦å®Œæˆé›†æˆå·¥ä½œï¼‰

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ¨¡å¼ | å®ç°çŠ¶æ€ | æµé‡æ”¯æŒ | CPUåˆ©ç”¨ | å®ç°å¤æ‚åº¦ |
|------|---------|---------|---------|-----------|
| ä¼ ç»ŸåŒ¹é…ï¼ˆä»å¤´ï¼‰ |  å®Œæˆ | 1 Gbps | 1æ ¸ | ç®€å• |
| æ»‘åŠ¨çª—å£ï¼ˆåŒæ­¥ï¼‰ |  å®Œæˆ | 500 Mbps | 1æ ¸ | ç®€å• |
| æ»‘åŠ¨çª—å£ + æµæ°´çº¿ | â¸ï¸ éƒ¨åˆ†å®Œæˆ | 2+ Gbps | å¤šæ ¸ | ä¸­ç­‰ |

## ğŸ”§ ä¸‹ä¸€æ­¥å·¥ä½œï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦å®Œæ•´çš„æµæ°´çº¿æ¶æ„ï¼Œè¿˜éœ€è¦ï¼š

1. **é›†æˆå†³ç­–**ï¼š
   - é€‰æ‹©å…¨å±€çº¿ç¨‹æ±  or æ¯ä¼šè¯çº¿ç¨‹
   - ç¡®å®šæ¶ˆæ¯æ¨¡å¼ or é˜Ÿåˆ—æ¨¡å¼

2. **ä¿®æ”¹æŠ“åŒ…æµç¨‹**ï¼š
   - ä¿®æ”¹ `CRxCaptureJob::run_once()` æˆ– `dump_cb()`
   - å‘é€æ¶ˆæ¯ç»™è¿‡æ»¤çº¿ç¨‹ï¼Œè€Œä¸æ˜¯ç›´æ¥å†™æ–‡ä»¶

3. **çº¿ç¨‹ç®¡ç†**ï¼š
   - åœ¨ `CRxProcData::init_threads()` æˆ–å…¶ä»–åœ°æ–¹åˆ›å»ºè¿‡æ»¤/å†™å…¥çº¿ç¨‹
   - å¤„ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ

4. **æµ‹è¯•éªŒè¯**ï¼š
   - å‹åŠ›æµ‹è¯•ï¼ˆé«˜æµé‡ï¼‰
   - åŠŸèƒ½æµ‹è¯•ï¼ˆæ»‘åŠ¨çª—å£æ­£ç¡®æ€§ï¼‰
   - æ€§èƒ½å¯¹æ¯”

## ğŸ“ API ä¸å˜

ç°æœ‰çš„ HTTP API å®Œå…¨ä¸å˜ï¼š

```bash
# å¯åŠ¨æŠ“åŒ…ï¼ˆè‡ªåŠ¨ä½¿ç”¨æ»‘åŠ¨çª—å£ï¼Œå¦‚æœ PDEF ä¸­å¯ç”¨ï¼‰
POST /api/pdef/upload
POST /api/capture/start
POST /api/capture/stop
GET  /api/capture/status
```

## ğŸ‰ æ ¸å¿ƒæˆæœ

1.  **PDEF æ»‘åŠ¨çª—å£åŠŸèƒ½å®Œå…¨å¯ç”¨**
2.  **è¯­æ³•æ¸…æ™°ï¼Œæ˜“äºä½¿ç”¨**
3.  **æ€§èƒ½ä¼˜åŒ–æªæ–½åˆ°ä½**
4.  **å‘åå…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ PDEF**
5.  **æµæ°´çº¿åŸºç¡€è®¾æ–½å·²å‡†å¤‡ï¼ˆå¯é€‰ï¼‰**

## ç¤ºä¾‹ï¼šå®Œæ•´å·¥ä½œæµ

```bash
# 1. ä¸Šä¼ æ”¯æŒæ»‘åŠ¨çª—å£çš„ PDEF
curl -X POST http://localhost:8080/api/pdef/upload \
  --data-binary @config/protocols/iec104.pdef

# å“åº”ï¼š
# {
#   "status": "ok",
#   "path": "/tmp/rxtracenetcap_pdef/rxtracenetcap_pdef_xxx.pdef",
#   "validated": true
# }

# 2. å¯åŠ¨æŠ“åŒ…ï¼ˆè‡ªåŠ¨åº”ç”¨æ»‘åŠ¨çª—å£ï¼‰
curl -X POST http://localhost:8080/api/capture/start \
  -H "Content-Type: application/json" \
  -d '{
    "iface": "eth0",
    "filter": "tcp port 2404",
    "protocol_filter": "/tmp/rxtracenetcap_pdef/rxtracenetcap_pdef_xxx.pdef"
  }'

# 3. æ»‘åŠ¨çª—å£è‡ªåŠ¨ç”Ÿæ•ˆ
# - å¦‚æœ PDEF ä¸­æœ‰ sliding = trueï¼Œè‡ªåŠ¨ä½¿ç”¨æ»‘åŠ¨çª—å£
# - å¦åˆ™ä½¿ç”¨ä¼ ç»Ÿçš„ä»å¤´åŒ¹é…
```

## æŠ€æœ¯ç»†èŠ‚

### æ»‘åŠ¨çª—å£å®ç°ï¼ˆprotocol.c:31-50ï¼‰

```c
if (rule->sliding_window) {
    uint32_t search_limit = packet_len;
    if (rule->sliding_max_offset > 0) {
        search_limit = min(search_limit, rule->sliding_max_offset);
    }

    for (uint32_t offset = 0; offset < search_limit; offset++) {
        if (remaining < rule->min_packet_size) break;
        if (execute_filter(packet + offset, remaining, rule)) {
            return true;
        }
    }
}
```

### ç¼–è¯‘çŠ¶æ€

```bash
$ make pdef
#  ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯
```
