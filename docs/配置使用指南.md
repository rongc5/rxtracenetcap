# RxTraceNetCap 配置使用指南

##  目录

- [一、项目概述](#一项目概述)
- [二、配置文件说明](#二配置文件说明)
  - [2.1 主配置文件 (rxtracenetcap.json)](#21-主配置文件-rxtracenetcapjson)
  - [2.2 策略配置文件 (strategy.json)](#22-策略配置文件-strategyjson)
- [三、配置示例](#三配置示例)
- [四、常见问题](#四常见问题)

---

## 一、项目概述

RxTraceNetCap 是一个基于 HTTP 服务的网络抓包管理系统，提供 RESTful API 接口和命令行工具，用于自动化网络流量采集、监控和故障诊断。

### 核心特性

- **多种抓包模式**：支持按网卡、进程、PID、容器等方式抓包
- **HTTP API 接口**：RESTful 风格，易于集成到自动化运维系统
- **命令行工具**：提供 `rxcli` 客户端，支持批量操作
- **自动化触发**：根据 CPU、内存、网络流量等指标自动触发抓包
- **文件管理**：自动压缩、归档和清理，支持保留时间和空间限制
- **并发控制**：可配置最大并发抓包数，防止资源耗尽
- **热重载配置**：策略配置支持热重载，无需重启服务

---

## 二、配置文件说明

系统使用两个 JSON 配置文件：

| 配置文件 | 用途 | 修改频率 | 需要重启 |
|---------|------|---------|----------|
| **rxtracenetcap.json** | 系统级配置（服务器、资源限制、存储） | 很少 |  是 |
| **strategy.json** | 业务级配置（触发器、协议映射） | 经常 |  否（热加载） |

---

### 2.1 主配置文件 (rxtracenetcap.json)

主配置文件位于 `config/rxtracenetcap.json`，包含系统级配置。**修改后需要重启服务生效。**

#### 完整示例

```json
{
  "server": {
    "bind_addr": "0.0.0.0",
    "port": 8080,
    "workers": 2,
    "capture_threads": 4
  },
  "logging": {
    "log_path": "logs/rxtracenetcap.log",
    "log_prefix": "rxtrace",
    "log_size_mb": 100,
    "log_level": 16
  },
  "capture": {
    "default_interface": "any",
    "default_duration": 60,
    "default_category": "diag",
    "file_pattern": "{category}/{day}/{date}-{proc}-{port}.pcap",
    "max_file_size_mb": 200
  },
  "storage": {
    "base_dir": "/var/log/rxtrace/captures",
    "max_age_days": 7,
    "max_size_gb": 10,
    "temp_pdef_dir": "/var/log/rxtrace/pdef_tmp",
    "temp_pdef_ttl_hours": 72
  },
  "cleanup": {
    "batch_compress_file_count": 5,
    "batch_compress_size_mb": 512,
    "archive_dir": "/var/log/rxtrace/archives",
    "archive_keep_days": 14,
    "archive_max_total_size_mb": 0,
    "archive_remove_source": true
  },
  "limits": {
    "max_concurrent_captures": 8
  }
}
```

#### 配置项说明

##### server（服务器配置）

| 配置项 | 说明 | 默认值 | 推荐值 |
|-------|------|--------|--------|
| `bind_addr` | HTTP 服务监听地址 | `0.0.0.0` | `0.0.0.0`（所有接口）或 `127.0.0.1`（仅本地） |
| `port` | HTTP 服务端口号 | `8080` | `8080` |
| `workers` | HTTP 工作线程数 | `2` | 2-4（根据并发量） |
| `capture_threads` | 抓包工作线程数 | `4` | 4-8 |

##### logging（日志配置）

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| `log_path` | 日志文件路径 | `logs/rxtracenetcap.log` |
| `log_prefix` | 日志文件名前缀 | `rxtrace` |
| `log_size_mb` | 单个日志文件最大大小（MB） | `100` |
| `log_level` | 日志级别（16=DEBUG, 8=INFO, 4=WARNING, 2=ERROR） | `16` |

##### capture（抓包默认配置）

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| `default_interface` | 默认网卡接口 | `any`（所有接口） |
| `default_duration` | 默认抓包时长（秒） | `60` |
| `default_category` | 默认分类标签 | `diag` |
| `file_pattern` | 输出文件命名模板 | `{day}/{date}-{iface}-{proc}-{port}.pcap` |
| `max_file_size_mb` | 单个文件最大大小（MB） | `200` |

**file_pattern 支持的占位符：**

| 占位符 | 说明 | 示例值 |
|--------|------|--------|
| `{day}` | 日期目录 | `2025-01-15` |
| `{date}` | 日期时间戳 | `202501151430` |
| `{ts}` | Unix 时间戳 | `1705315800` |
| `{iface}` | 网络接口 | `eth0` 或 `any` |
| `{proc}` | 进程名 | `nginx` 或 `any` |
| `{port}` | 端口 | `80` 或 `any` |
| `{seq}` | 序列号 | `0001` |
| `{category}` | 分类标签 | `auto-nginx`, `diag` |

**推荐的 file_pattern：**
```json
"{category}/{day}/{date}-{proc}-{port}.pcap"
```

这样可以按类别自动分目录存储：
```
/var/log/rxtrace/captures/
 auto-nginx/
    2025-01-15/
        202501151430-nginx-80.pcap
 mem-crit/
    2025-01-15/
        202501151432-any-any.pcap
 diag/
     2025-01-15/
         202501151435-any-any.pcap
```

##### storage（存储配置）

| 配置项 | 说明 | 默认值 | 推荐值 |
|-------|------|--------|--------|
| `base_dir` | 抓包文件存储目录 | `/var/log/rxtrace/captures` | 确保有足够空间 |
| `max_age_days` | 文件最大保留天数 | `7` | 7-14 |
| `max_size_gb` | 存储目录最大容量（GB） | `10` | 根据磁盘空间调整 |
| `temp_pdef_dir` | 临时 PDEF 文件目录 | `/var/log/rxtrace/pdef_tmp` | - |
| `temp_pdef_ttl_hours` | 临时 PDEF 文件保留时间（小时） | `72` | 72-168 |

##### cleanup（清理配置）

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| `batch_compress_file_count` | 批量压缩文件数量阈值 | `5` |
| `batch_compress_size_mb` | 批量压缩大小阈值（MB） | `512` |
| `archive_dir` | 归档文件存储目录 | `/var/log/rxtrace/archives` |
| `archive_keep_days` | 归档文件保留天数 | `14` |
| `archive_max_total_size_mb` | 归档文件最大总大小（MB，0表示无限制） | `0` |
| `archive_remove_source` | 归档后是否删除源文件 | `true` |

##### limits（资源限制）

| 配置项 | 说明 | 默认值 | 推荐值 |
|-------|------|--------|--------|
| `max_concurrent_captures` | 最大并发抓包数 | `8` | 5-10（根据服务器性能） |

**并发数参考标准：**

| 服务器规格 | 推荐值 | 说明 |
|-----------|--------|------|
| 小型（2核4G） | 3-5 | 保守配置 |
| 中型（4核8G） | 5-8 | 平衡配置  |
| 大型（8核16G+） | 8-15 | 高性能配置 |

---

### 2.2 策略配置文件 (strategy.json)

策略配置文件位于 `config/strategy.json`，包含业务级配置。**支持热重载，无需重启服务。**

#### 完整示例

```json
{
  "sample": {
    "triggers": [
      {
        "name": "cpu_warning",
        "cpu_pct_gt": 85,
        "trigger_capture": "iface:any",
        "capture_category": "cpu-warn",
        "capture_duration_sec": 30,
        "cooldown_sec": 600
      },
      {
        "name": "cpu_critical",
        "cpu_pct_gt": 95,
        "trigger_capture": "iface:any",
        "capture_category": "cpu-crit",
        "capture_duration_sec": 120,
        "cooldown_sec": 300
      },
      {
        "name": "memory_spike",
        "mem_pct_gt": 92,
        "trigger_capture": "iface:any",
        "capture_category": "mem-spike",
        "capture_duration_sec": 60,
        "cooldown_sec": 600
      },
      {
        "name": "nginx_traffic",
        "net_rx_kbps_gt": 10000,
        "trigger_capture": "process:nginx",
        "capture_category": "web-nginx",
        "capture_duration_sec": 90,
        "cooldown_sec": 600
      },
      {
        "name": "mysql_traffic",
        "net_rx_kbps_gt": 8000,
        "trigger_capture": "process:mysqld",
        "capture_category": "db-mysql",
        "capture_duration_sec": 60,
        "cooldown_sec": 600
      }
    ]
  },
  "protocols": {
    "mysql": "config/protocols/mysql.pdef",
    "redis": "config/protocols/redis.pdef",
    "http": "config/protocols/http.pdef",
    "dns": "config/protocols/dns.pdef",
    "mqtt": "config/protocols/mqtt.pdef",
    "iec104": "config/protocols/iec104.pdef",
    "memcached": "config/protocols/memcached.pdef"
  }
}
```

#### 配置项说明

##### sample.triggers（自动触发器）

每个触发器包含以下字段：

| 字段 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `name` |  | 触发器名称（唯一标识） | `"cpu_critical"` |
| `cpu_pct_gt` |  | CPU 使用率阈值（大于该值触发） | `85` |
| `mem_pct_gt` |  | 内存使用率阈值（大于该值触发） | `92` |
| `net_rx_kbps_gt` |  | 网络接收速率阈值（KB/s，大于该值触发） | `10000` |
| `trigger_capture` |  | 抓包目标 | `"iface:any"`, `"process:nginx"` |
| `capture_category` |  | 分类标签（用于文件路径） | `"auto-nginx"` |
| `capture_duration_sec` |  | 抓包持续时间（秒） | `90` |
| `cooldown_sec` |  | 冷却期（秒，避免频繁触发） | `300` |

**注意：** 每个触发器至少要有一个阈值（`cpu_pct_gt`、`mem_pct_gt` 或 `net_rx_kbps_gt`）。

**trigger_capture 支持的格式：**

| 格式 | 说明 | 示例 |
|------|------|------|
| `iface:接口名` | 抓取指定网卡流量 | `"iface:eth0"`, `"iface:any"` |
| `process:进程名` | 抓取指定进程流量 | `"process:nginx"`, `"process:mysqld"` |
| `pid:进程ID` | 抓取指定 PID 流量 | `"pid:12345"` |
| `container:容器ID` | 抓取指定容器流量 | `"container:abc123"` |

**触发器工作流程：**

1. 系统定期采样 CPU、内存、网络指标
2. 当指标超过触发器阈值时，自动启动抓包
3. 按配置的时长抓包
4. 进入冷却期，期间不会重复触发同一规则

**分级响应示例：**

对同一指标配置多个触发器，实现分级响应：

```json
{
  "triggers": [
    {
      "name": "mem_warning",
      "mem_pct_gt": 85,
      "capture_duration_sec": 30,
      "cooldown_sec": 600
    },
    {
      "name": "mem_critical",
      "mem_pct_gt": 95,
      "capture_duration_sec": 120,
      "cooldown_sec": 300
    }
  ]
}
```

##### protocols（协议映射）

将协议名称映射到 PDEF（协议定义）文件路径：

```json
{
  "protocols": {
    "http": "config/protocols/http.pdef",
    "mysql": "config/protocols/mysql.pdef"
  }
}
```

---

## 三、配置示例

### 3.1 生产环境推荐配置

#### rxtracenetcap.json
```json
{
  "server": {
    "bind_addr": "0.0.0.0",
    "port": 8080,
    "workers": 4,
    "capture_threads": 6
  },
  "logging": {
    "log_path": "/var/log/rxtrace/rxtracenetcap.log",
    "log_prefix": "rxtrace",
    "log_size_mb": 200,
    "log_level": 8
  },
  "capture": {
    "default_interface": "any",
    "default_duration": 60,
    "default_category": "diag",
    "file_pattern": "{category}/{day}/{date}-{proc}-{port}.pcap",
    "max_file_size_mb": 500
  },
  "storage": {
    "base_dir": "/data/rxtrace/captures",
    "max_age_days": 14,
    "max_size_gb": 50,
    "temp_pdef_dir": "/data/rxtrace/pdef_tmp",
    "temp_pdef_ttl_hours": 168
  },
  "cleanup": {
    "batch_compress_file_count": 10,
    "batch_compress_size_mb": 1024,
    "archive_dir": "/data/rxtrace/archives",
    "archive_keep_days": 30,
    "archive_max_total_size_mb": 10240,
    "archive_remove_source": true
  },
  "limits": {
    "max_concurrent_captures": 8
  }
}
```

#### strategy.json
```json
{
  "sample": {
    "triggers": [
      {
        "name": "cpu_high",
        "cpu_pct_gt": 90,
        "trigger_capture": "iface:any",
        "capture_category": "cpu-high",
        "capture_duration_sec": 60,
        "cooldown_sec": 600
      },
      {
        "name": "mem_high",
        "mem_pct_gt": 90,
        "trigger_capture": "iface:any",
        "capture_category": "mem-high",
        "capture_duration_sec": 60,
        "cooldown_sec": 600
      },
      {
        "name": "nginx_burst",
        "net_rx_kbps_gt": 15000,
        "trigger_capture": "process:nginx",
        "capture_category": "web-burst",
        "capture_duration_sec": 120,
        "cooldown_sec": 900
      }
    ]
  },
  "protocols": {
    "http": "config/protocols/http.pdef",
    "mysql": "config/protocols/mysql.pdef",
    "redis": "config/protocols/redis.pdef"
  }
}
```

### 3.2 开发/测试环境配置

#### rxtracenetcap.json
```json
{
  "server": {
    "bind_addr": "127.0.0.1",
    "port": 8080,
    "workers": 2,
    "capture_threads": 2
  },
  "logging": {
    "log_path": "logs/rxtracenetcap.log",
    "log_prefix": "rxtrace",
    "log_size_mb": 50,
    "log_level": 16
  },
  "capture": {
    "default_interface": "lo",
    "default_duration": 30,
    "default_category": "test",
    "file_pattern": "{day}/{date}-{proc}.pcap",
    "max_file_size_mb": 50
  },
  "storage": {
    "base_dir": "./captures",
    "max_age_days": 3,
    "max_size_gb": 5,
    "temp_pdef_dir": "./pdef_tmp",
    "temp_pdef_ttl_hours": 24
  },
  "cleanup": {
    "batch_compress_file_count": 3,
    "batch_compress_size_mb": 100,
    "archive_dir": "./archives",
    "archive_keep_days": 7,
    "archive_max_total_size_mb": 1024,
    "archive_remove_source": true
  },
  "limits": {
    "max_concurrent_captures": 3
  }
}
```

#### strategy.json
```json
{
  "sample": {
    "triggers": []
  },
  "protocols": {
    "http": "config/protocols/http.pdef"
  }
}
```

---

## 四、常见问题

### 4.1 如何重新加载策略配置？

策略配置（strategy.json）支持热重载：

```bash
# 方法1：通过 API
curl -X POST http://localhost:8080/api/reload

# 方法2：发送 SIGHUP 信号
kill -HUP $(cat /var/run/rxtracenetcap.pid)
```

**注意：** 主配置（rxtracenetcap.json）修改后需要重启服务。

### 4.2 如何查看当前并发抓包数？

```bash
curl http://localhost:8080/api/status
```

返回示例：
```json
{
  "running_captures": 3,
  "pending_captures": 0,
  "max_concurrent": 8
}
```

### 4.3 抓包文件存储在哪里？

根据 `storage.base_dir` 和 `capture.file_pattern` 配置决定。

例如，配置为：
```json
{
  "storage": {
    "base_dir": "/var/log/rxtrace/captures"
  },
  "capture": {
    "file_pattern": "{category}/{day}/{date}-{proc}-{port}.pcap"
  }
}
```

则文件路径为：
```
/var/log/rxtrace/captures/auto-nginx/2025-01-15/202501151430-nginx-80.pcap
```

### 4.4 如何禁用自动触发器？

将 `strategy.json` 中的 `triggers` 设置为空数组：

```json
{
  "sample": {
    "triggers": []
  }
}
```

然后重新加载配置：
```bash
curl -X POST http://localhost:8080/api/reload
```

### 4.5 触发器冷却期是什么？

冷却期（`cooldown_sec`）是指触发器触发后，在指定时间内不会再次触发。

例如，设置 `cooldown_sec: 600`：
- 10:00 触发抓包
- 10:01-10:10 期间即使条件满足也不会触发
- 10:10 之后可以再次触发

这样可以避免频繁抓包导致资源耗尽。

### 4.6 如何监控触发器触发情况？

查看日志文件：

```bash
tail -f /var/log/rxtrace/rxtracenetcap.log | grep "Sample alert"
```

日志示例：
```
[2025-01-15 14:30:00] NOTICE: Sample alert handled id=123 module=cpu_high CPU=1 MEM=0 NET=0
[2025-01-15 14:30:01] NOTICE: Auto capture triggered by module 'cpu_high'
```

### 4.7 达到并发限制怎么办？

当并发抓包数达到 `max_concurrent_captures` 时，新请求会被拒绝：

```
HTTP/1.1 429 Too Many Requests
{
  "error": "Max concurrent capture limit (8) reached"
}
```

**解决方法：**
1. 等待正在运行的抓包任务完成
2. 增加 `max_concurrent_captures` 值（需要重启服务）
3. 减少触发器触发频率（增加 `cooldown_sec`）
4. 缩短抓包时长（`capture_duration_sec`）

### 4.8 如何按类别组织抓包文件？

使用 `{category}` 占位符：

```json
{
  "capture": {
    "file_pattern": "{category}/{day}/{date}-{proc}-{port}.pcap"
  }
}
```

在触发器中指定 `capture_category`：

```json
{
  "triggers": [
    {
      "name": "nginx_traffic",
      "capture_category": "web-nginx",
      ...
    }
  ]
}
```

文件将自动存储在：
```
/var/log/rxtrace/captures/web-nginx/2025-01-15/...
```

---

## 附录：配置文件模板

### A.1 最小化配置

#### rxtracenetcap.json
```json
{
  "server": {
    "bind_addr": "0.0.0.0",
    "port": 8080,
    "workers": 2,
    "capture_threads": 4
  },
  "logging": {
    "log_path": "logs/rxtracenetcap.log",
    "log_prefix": "rxtrace",
    "log_size_mb": 100,
    "log_level": 16
  },
  "capture": {
    "default_interface": "any",
    "default_duration": 60,
    "default_category": "diag",
    "file_pattern": "{day}/{date}-{iface}-{proc}-{port}.pcap",
    "max_file_size_mb": 200
  },
  "storage": {
    "base_dir": "/var/log/rxtrace/captures",
    "max_age_days": 7,
    "max_size_gb": 10,
    "temp_pdef_dir": "/var/log/rxtrace/pdef_tmp",
    "temp_pdef_ttl_hours": 72
  },
  "cleanup": {
    "batch_compress_file_count": 5,
    "batch_compress_size_mb": 512,
    "archive_dir": "/var/log/rxtrace/archives",
    "archive_keep_days": 14,
    "archive_max_total_size_mb": 0,
    "archive_remove_source": true
  },
  "limits": {
    "max_concurrent_captures": 8
  }
}
```

#### strategy.json
```json
{
  "sample": {
    "triggers": []
  },
  "protocols": {}
}
```

---

**文档版本：** v2.0
**最后更新：** 2025-01-15
**适用版本：** RxTraceNetCap 2.x（JSON 配置格式）
