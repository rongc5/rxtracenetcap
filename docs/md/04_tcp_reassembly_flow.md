# TCP 流重组流程图

## 描述
此流程图详细展示了 TCP 数据包重组的过程，包括连接跟踪、序列号处理、乱序重组和完整性检查。

## 流程图

```mermaid
flowchart TD
    A[TCP 数据包] --> B[提取连接信息]
    B --> C{连接是否存在?}
    C -->|否| D[创建新连接]
    C -->|是| E[获取连接状态]
    
    D --> F[初始化序列号]
    F --> G[创建重组缓冲区]
    G --> H[添加到连接表]
    H --> E
    
    E --> I[检查序列号]
    I --> J{序列号正确?}
    J -->|是| K[添加到缓冲区]
    J -->|否| L{是否乱序?}
    
    L -->|是| M[插入到正确位置]
    L -->|否| N[检查是否重传]
    N -->|是| O[更新重传统计]
    N -->|否| P[丢弃异常包]
    
    K --> Q[检查缓冲区连续性]
    M --> Q
    Q --> R{是否有完整消息?}
    R -->|是| S[提取完整消息]
    R -->|否| T[等待更多数据]
    
    S --> U[更新连接状态]
    U --> V[传递给协议解析器]
    V --> W[清理已处理数据]
    
    O --> X[记录统计信息]
    P --> X
    T --> Y[检查超时]
    Y --> Z{是否超时?}
    Z -->|是| AA[清理过期连接]
    Z -->|否| BB[继续等待]
    
    W --> BB
    X --> BB
    AA --> BB
    
    style A fill:#e3f2fd
    style D fill:#e8f5e8
    style S fill:#e8f5e8
    style P fill:#ffebee
    style AA fill:#ffebee
```

## 详细说明

### 1. 连接管理
- **连接识别**：基于五元组（源IP、目标IP、源端口、目标端口、协议）
- **连接状态**：跟踪 TCP 连接的建立、数据传输、关闭状态
- **连接表**：维护活跃连接的哈希表，支持快速查找

### 2. 序列号处理
- **初始序列号**：记录连接建立时的初始序列号
- **相对序列号**：转换为相对序列号便于处理
- **序列号验证**：检查接收到的序列号是否在有效窗口内

### 3. 乱序处理
- **乱序检测**：比较接收序列号与期望序列号
- **插入排序**：将乱序包插入到缓冲区的正确位置
- **连续性检查**：检查缓冲区中是否形成连续的数据流

### 4. 重传处理
- **重传检测**：识别重复的序列号范围
- **重传统计**：记录重传包的数量和频率
- **去重处理**：避免重复数据影响解析结果

### 5. 完整性检查
- **消息边界**：根据协议特征确定消息的完整性
- **缓冲区管理**：动态调整缓冲区大小
- **内存控制**：防止缓冲区无限增长

### 6. 超时处理
- **连接超时**：清理长时间无活动的连接
- **数据超时**：处理长时间未完成重组的数据
- **资源回收**：及时释放不再需要的内存资源

## 性能优化

1. **哈希表优化**：使用高效的哈希算法加速连接查找
2. **内存池**：预分配内存池减少动态分配开销
3. **批量处理**：批量处理多个数据包提高效率
4. **并行重组**：对不同连接的数据并行处理
